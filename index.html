<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ekalo Mode Camp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin: 0; padding: 0;
  font-family: 'Cairo', sans-serif;
  background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
  color: #004d40;
  display: flex; flex-direction: column; align-items: center;
  min-height: 100vh;
}
nav {
  background-color: #223716;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 2em;
  padding: 1.5em 1em;
  font-size: 1.3em;
  width: 100%;
}
nav a { color: white; text-decoration: none; transition: 0.3s; }
nav a:hover { color: #ffeb3b; }
h1 { margin: 1em 0; font-size: 2em; text-align: center; }
#teamsChartContainer {
  width: 90%;
  max-width: 600px;
  background: white;
  border-radius: 15px;
  padding: 1em;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
  margin-bottom: 2em;
}
footer {
  text-align: center;
  padding: 1em;
  background-color: #004d40;
  color: #ccc;
  font-size: 0.9em;
  width: 100%;
  margin-top: auto;
}
.timer-overlay {
  position: fixed; top: 0; left: 0;
  width: 100vw; height: 100vh;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  text-align: center;
  z-index: 9999;
  transition: background 0.5s, color 0.5s;
  font-size: 3em;
}
#overlay-time { font-size: 4em; margin-bottom: 0.3em; }
#overlay-activity { font-size: 1.5em; }
.logo-container {
  position: absolute;
  top: 10px;
  left: 70px;
  z-index: 10;
}
.logo {
  width: 75px; height: 75px; border-radius: 50%;
  object-fit: cover; border: 3px solid #fff;
  box-shadow: 0 3px 12px rgba(0,0,0,0.2);
  transition: transform 0.4s ease, box-shadow 0.4s ease;
}
.logo:hover {
  transform: scale(1.15) rotate(3deg);
  box-shadow: 0 6px 18px rgba(0,0,0,0.3);
}
</style>
</head>
<body>

<nav>
  <a href="#">Home</a>
  <a href="rooms.html">Rooms</a>
  <a href="teams.html">Teams</a>
  <a href="rules.html">Rules</a>
    <a href="program.html">Program</a>

  <div class="logo-container">
    <img src="logo.jpg" alt="Ekalo Mode Logo" class="logo">
  </div>
</nav>

<h1>ðŸ“Š Live Team Scores</h1>

<div id="teamsChartContainer">
  <canvas id="teamsChart"></canvas>
</div>

<footer>Â© 2025 Ekalo Mode Camp. All rights reserved.</footer>

<div id="timer-overlay" class="timer-overlay" style="display:none;">
  <div id="overlay-time">--:--</div>
  <div id="overlay-activity">Loading...</div>
</div>

<script>
// Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission().catch(()=>{});
}

// === Ø§Ù„ØªØ§ÙŠÙ…Ø± ===
let schedule = [];
let notifiedActivities = {};

async function fetchSchedule() {
    try {
        const response = await fetch('https://opensheet.elk.sh/1c3WdLvAbbhd6bPcWRHKXjXeNt9wknwWnyMko3HBMpXU/time');
        const data = await response.json();
        schedule = data.map(row => ({
            time: row.Time,
            name: row.Name
        }));
        console.log("âœ… Schedule updated:", schedule);
    } catch (error) {
        console.error("âŒ Error fetching schedule:", error);
    }
}

const overlay = document.getElementById('timer-overlay');
const overlayTime = document.getElementById('overlay-time');
const overlayActivity = document.getElementById('overlay-activity');

function updateOverlay() {
    const now = new Date();
    if (!schedule.length) return;

    for (let item of schedule) {
        if (!item.time || !item.name) continue;
        const [h, m] = item.time.split(":").map(Number);
        const start = new Date();
        start.setHours(h, m, 0, 0);
        const before5Min = new Date(start.getTime() - 5 * 60000);
        const after5Min = new Date(start.getTime() + 5 * 60000);

        if (now >= before5Min && now <= after5Min) {
            overlay.style.display = "flex";
            document.body.style.overflow = "hidden";

            if (now < start) {
                const diffMs = start - now;
                const min = Math.floor(diffMs / 60000);
                const sec = Math.floor((diffMs % 60000) / 1000);
                overlayTime.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
                overlayActivity.textContent = `â³ Upcoming: ${item.name}`;
                overlay.style.background = "linear-gradient(135deg, #fff9c4, #fffde7)";
                overlay.style.color = "#004d40";
            } else {
                const diffMs = now - start;
                const min = Math.floor(diffMs / 60000);
                const sec = Math.floor((diffMs % 60000) / 1000);
                overlayTime.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
                overlayActivity.textContent = `ðŸ”´ Now: ${item.name}`;
                overlay.style.background = "#d32f2f";
                overlay.style.color = "#fff";

                if (!notifiedActivities[item.time]) {
                    if (Notification.permission === "granted") {
                        new Notification("â° Activity Started!", {
                            body: `${item.name} has started now.`,
                            icon: "https://cdn-icons-png.flaticon.com/512/929/929564.png"
                        });
                    }
                    notifiedActivities[item.time] = true;
                }
            }
            return;
        }
    }

    overlay.style.display = "none";
    document.body.style.overflow = "auto";
}

// === Ø§Ù„Ø´Ø§Ø±Øª ===
let teams = [];

async function fetchTeams() {
    try {
        const response = await fetch('https://opensheet.elk.sh/1c3WdLvAbbhd6bPcWRHKXjXeNt9wknwWnyMko3HBMpXU/Sheet1');
        const data = await response.json();
        const newTeams = data.map(row => ({
            name: row.Name || row.name || "Unnamed",
            score: Number(row.Score || row.score || 0)
        }));

        const changed = JSON.stringify(newTeams) !== JSON.stringify(teams);
        if (changed) {
            teams = newTeams;
            updateTeamsChart();
            console.log("âœ… Chart updated with new data.");
        }
    } catch (error) {
        console.error("âŒ Error fetching team data:", error);
    }
}

const ctx = document.getElementById('teamsChart').getContext('2d');
const teamsChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [],
        datasets: [{
            label: 'Points',
            data: [],
            backgroundColor: [
                '#f44336', '#2196f3', '#4caf50',
                '#ff9800', '#9c27b0', '#3f51b5', '#00bcd4'
            ],
            borderRadius: 10
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            title: {
                display: true,
                text: 'Team Scores',
                font: { size: 20 }
            }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

function updateTeamsChart() {
    teamsChart.data.labels = teams.map(t => t.name);
    teamsChart.data.datasets[0].data = teams.map(t => t.score);
    teamsChart.update();
}

// === ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø± ===
fetchSchedule();
setInterval(fetchSchedule, 5000);
setInterval(updateOverlay, 1000);

fetchTeams();
setInterval(fetchTeams, 3000);

</script>

</body>
</html>
